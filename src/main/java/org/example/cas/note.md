# CAS

compare and swap的縮寫，翻譯成**比較並交換**，實現並發算法時常用到的一種技術。<br>
它包含3個操作數：內存位置的值、預期值及更新值。<br>

執行CAS操作時，將內存位置的值與預期值比較：
* 如果**相匹配**，那麼處理器會自動將該位置值更新為新值。
* 如果**不匹配**，處理器不做任何操作，多個線程同時執行CAS操作只有一個會成功。

CAS有3個操作數，內存位置值V、舊的預期值A和要修改的更新值B。<br>
當舊的預期值A和內存值V相同時，將內存值V修改為B，否則什麼都不做或重來。<br>
當他重來重試的這種行為稱為 - **自旋**

![img.png](img.png)

## 自旋鎖(spinlock)
CAS是自旋鎖的基礎，CAS利用CPU指令保證了操作的原子性，以達到鎖的效果，至於自旋呢，看字面意思也很明白，自己旋轉。<br>
是指嘗試獲取鎖的線程不會立即阻塞，而是**採用循環的方式去嘗試獲取鎖**，當線程發現鎖被佔用時，會不斷循環判斷鎖的狀態，直到獲取。這樣的好處是減少線程上下文切換的消耗，缺點是循環會**消耗CPU**。

## CAS缺點

### 循環時間長開銷很大
* `getAndAddInt()`方法有一個do-while
* 如果CAS失敗，會一直進行嘗試，如果CAS長時間一直不成功，可能會給CPU帶來很大的開銷

### 引出ABA問題
CAS算法實現一個重要前提需要取出內存中某個時刻的數據並在當下時刻比較並替換，那麼在這個時間差類會導致數據的變化。<br>
比如說一個線程1從內存位置V中取出A，這時候另一個線程2也從內存中取出A，並且線程2進行了一些操作將直變成了B，然後線程2又將V位置的數據變成A，這時後線程1進行CAS操作發現內存中仍然是A，預期OK，然後線程1操作成功。<br>
**儘管線程1的CAS操作成功，但是不代表這個過程就是沒有問題的**。